name: Prepare Release PR

on:
  push:
    branches:
      - main
    paths:
      - ".changeset/**"
      - "scripts/release-prepare/**"
      - "scripts/release-finalize/**"
      - "package.json"
      - ".github/workflows/release-pr.yml"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  prepare-release-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Resolve release target version
        id: release
        run: |
          echo "## Release PR status" >> "$GITHUB_STEP_SUMMARY"
          RELEASE_VERSION=$(bun -e 'const p = JSON.parse(await Bun.file("package.json").text()); console.log(p.version)')
          echo "version=$RELEASE_VERSION" >> "$GITHUB_OUTPUT"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- âœ… Target release version resolved: v${RELEASE_VERSION}" >> "$GITHUB_STEP_SUMMARY"

      - name: Prepare release artifacts from changesets
        id: prepare_artifacts
        run: |
          bun run release:prepare
          echo "- âœ… Release artifacts prepared from changesets" >> "$GITHUB_STEP_SUMMARY"

      - name: Prepare release notes excerpt from root changelog
        id: prepare_release_notes
        run: |
          bun run release:finalize
          echo "- âœ… Release notes excerpt prepared from root CHANGELOG.md" >> "$GITHUB_STEP_SUMMARY"

      - name: Build release PR body
        id: build_pr_body
        env:
          RELEASE_VERSION: ${{ steps.release.outputs.version }}
        run: |
          BODY_FILE=.release-pr-body.md
          RELEASE_NOTES_FILE=.release-notes.md

          cat > "$BODY_FILE" <<'EOF'
          This PR was auto-generated from `.changeset/*.md` files.

          ## What this PR does

          - Removes processed changesets
          - Bumps affected skill `metadata.version`
          - Updates `skills/<skill>/CHANGELOG.md`
          - Bumps root `package.json` version
          - Updates root `CHANGELOG.md`

          EOF

          {
            echo "## Release summary"
            echo
            echo "- Target version: \`v${RELEASE_VERSION}\`"
            echo "- Release notes source: root \`CHANGELOG.md\` section \`## v${RELEASE_VERSION}\`"
            echo
          } >> "$BODY_FILE"

          cat "$RELEASE_NOTES_FILE" >> "$BODY_FILE"

          echo "" >> "$BODY_FILE"

          echo "- âœ… Release PR body generated" >> "$GITHUB_STEP_SUMMARY"

      - name: Create or update release PR
        id: create_release_pr
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore(release): apply skill changesets"
          title: "ðŸ¤– Bip Bop - Release skills"
          body-path: ".release-pr-body.md"
          branch: "release/skills"
          labels: |
            release
            automated
          add-paths: |
            skills/**/SKILL.md
            skills/**/CHANGELOG.md
            .changeset/*.md
            package.json
            CHANGELOG.md
            README.md

      - name: Report release PR action
        if: steps.create_release_pr.outcome == 'success'
        env:
          PR_OPERATION: ${{ steps.create_release_pr.outputs.pull-request-operation }}
          PR_NUMBER: ${{ steps.create_release_pr.outputs.pull-request-number }}
          PR_URL: ${{ steps.create_release_pr.outputs.pull-request-url }}
        run: |
          if [[ "$PR_OPERATION" == "created" ]]; then
            echo "- âœ… Release PR created: #${PR_NUMBER}" >> "$GITHUB_STEP_SUMMARY"
          elif [[ "$PR_OPERATION" == "updated" ]]; then
            echo "- âœ… Release PR updated: #${PR_NUMBER}" >> "$GITHUB_STEP_SUMMARY"
          elif [[ "$PR_OPERATION" == "none" ]]; then
            echo "- â˜‘ï¸ No release PR changes needed" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "- âœ… Release PR operation: ${PR_OPERATION:-n/a}" >> "$GITHUB_STEP_SUMMARY"
          fi

          if [[ -n "$PR_URL" ]]; then
            echo "- ðŸ”— PR URL: ${PR_URL}" >> "$GITHUB_STEP_SUMMARY"
          fi

