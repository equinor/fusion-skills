name: Prepare Release PR

on:
  push:
    branches:
      - main
    paths:
      - ".changeset/**"
      - "scripts/release-prepare/**"
      - "scripts/release-finalize/**"
      - "package.json"
      - ".github/workflows/release-pr.yml"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  prepare-release-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Prepare release artifacts from changesets
        run: bun run release:prepare

      - name: Build release PR body
        run: |
          BODY_FILE=.release-pr-body.md

          cat > "$BODY_FILE" <<'EOF'
          This PR was auto-generated from `.changeset/*.md` files.

          ## What this PR does

          - Removes processed changesets
          - Bumps affected skill `metadata.version`
          - Updates `skills/<skill>/CHANGELOG.md`
          - Creates `.changeset/release.md` for publish automation

          EOF

          if [ -f .changeset/release.md ]; then
            RELEASE_BUMP=$(grep -E '^bump:[[:space:]]*(major|minor|patch)$' .changeset/release.md | head -n1 | sed -E 's/^bump:[[:space:]]*//')
            SKILLS=$(grep -E '^#{2,6}[[:space:]]+[a-z0-9][a-z0-9-]*@[0-9]+\.[0-9]+\.[0-9]+$' .changeset/release.md | sed -E 's/^#{2,6}[[:space:]]+//')

            {
              echo "## Release summary"
              echo
              if [ -n "$RELEASE_BUMP" ]; then
                echo "- Highest package bump: \`$RELEASE_BUMP\`"
              fi
              if [ -n "$SKILLS" ]; then
                echo "- Skills in this release:"
                echo "$SKILLS" | sed 's/^/- `/' | sed 's/$/`/'
              else
                echo "- Skills in this release: _none detected_"
              fi
              echo
              echo "## Release notes input (.changeset/release.md)"
              echo
              echo "\`\`\`markdown"
              cat .changeset/release.md
              echo "\`\`\`"
              echo
            } >> "$BODY_FILE"
          fi

      - name: Create or update release PR
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore(release): apply skill changesets"
          title: "ðŸ¤– Bip Bop - Release skills"
          body-path: ".release-pr-body.md"
          branch: "release/skills"
          labels: |
            release
            automated
          add-paths: |
            skills/**/SKILL.md
            skills/**/CHANGELOG.md
            .changeset/*.md
            .changeset/release.md
