name: Prepare Release PR

on:
  push:
    branches:
      - main
    paths:
      - ".changeset/**"
      - "scripts/release-prepare/**"
      - "scripts/release-finalize/**"
      - "package.json"
      - ".github/workflows/release-pr.yml"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  prepare-release-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Prepare release artifacts from changesets
        run: bun run release:prepare

      - name: Build release PR body
        run: |
          BODY_FILE=.release-pr-body.md

          cat > "$BODY_FILE" <<'EOF'
          This PR was auto-generated from `.changeset/*.md` files.

          ## What this PR does

          - Removes processed changesets
          - Bumps affected skill `metadata.version`
          - Updates `skills/<skill>/CHANGELOG.md`
          - Bumps root `package.json` version
          - Updates root `CHANGELOG.md`

          EOF

          RELEASE_VERSION=$(node -p "require('./package.json').version")
          {
            echo "## Release summary"
            echo
            echo "- Target version: \`v${RELEASE_VERSION}\`"
            echo "- Release notes source: root \`CHANGELOG.md\` section \`## v${RELEASE_VERSION}\`"
            echo
          } >> "$BODY_FILE"

      - name: Create or update release PR
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore(release): apply skill changesets"
          title: "ðŸ¤– Bip Bop - Release skills"
          body-path: ".release-pr-body.md"
          branch: "release/skills"
          labels: |
            release
            automated
          add-paths: |
            skills/**/SKILL.md
            skills/**/CHANGELOG.md
            .changeset/*.md
            package.json
            CHANGELOG.md
