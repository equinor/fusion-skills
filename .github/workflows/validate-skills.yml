name: Validate Skills

on:
  pull_request:
    paths:
      - "skills/**"
      - ".changeset/**"
      - ".github/workflows/validate-skills.yml"
  push:
    branches:
      - main
    paths:
      - "skills/**"
      - ".changeset/**"
      - ".github/workflows/validate-skills.yml"
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  validate:
    name: Validate skill catalog
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Validate skills and counts
        run: bun run validate:skills

      - name: Validate skill version bumps and changesets (PR only)
        if: github.event_name == 'pull_request'
        run: bun run validate:pr

      - name: Detect changed changeset files (PR only)
        if: github.event_name == 'pull_request'
        id: changed_changesets
        uses: tj-actions/changed-files@v47
        with:
          files: |
            .changeset/*.md
            !.changeset/README.md

      - name: Build changeset comment body (PR only)
        if: github.event_name == 'pull_request'
        run: |
          mkdir -p .tmp
          {
            echo "## Changeset summary"
            echo

            if [[ -z "${{ steps.changed_changesets.outputs.all_changed_files }}" ]]; then
              echo 'No `.changeset/*.md` files were changed in this PR.'
            else
              # Use tr to split space-separated file list into lines
              mapfile -t files < <(echo "${{ steps.changed_changesets.outputs.all_changed_files }}" | tr ' ' '\n' | sed '/^$/d' | sort)
              echo "Detected ${#files[@]} changeset file(s):"
              for file in "${files[@]}"; do
                echo
                echo "**$file:**"
                echo '```md'
                cat "$file"
                echo '```'
              done
            fi
          } > .tmp/changeset-summary.md

      - name: Comment changeset summary (PR only)
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          path: .tmp/changeset-summary.md
          header: changeset-summary
