name: Publish Release

on:
  push:
    branches:
      - main
    paths:
      - "CHANGELOG.md"
      - "scripts/release-prepare/**"
      - "scripts/release-finalize/**"
      - "package.json"
      - ".github/workflows/publish-release.yml"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Resolve version and tag state
        id: release
        run: |
          CURRENT_VERSION=$(bun -e 'const p = JSON.parse(await Bun.file("package.json").text()); console.log(p.version)')
          TAG="v${CURRENT_VERSION}"
          TAG_EXISTS=false
          if git ls-remote --exit-code --tags origin "refs/tags/${TAG}" >/dev/null 2>&1; then
            TAG_EXISTS=true
          fi

          echo "current=$CURRENT_VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "tag_exists=$TAG_EXISTS" >> "$GITHUB_OUTPUT"
          echo "Tag exists for ${TAG}: $TAG_EXISTS"

      - name: Finalize release artifacts
        if: steps.release.outputs.tag_exists != 'true'
        run: bun run release:finalize

      - name: Create and push release tag
        if: steps.release.outputs.tag_exists != 'true'
        env:
          TAG: ${{ steps.release.outputs.tag }}
        run: |
          git tag "$TAG"
          git push origin "$TAG"

      - name: Create GitHub Release
        if: steps.release.outputs.tag_exists != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          TAG: ${{ steps.release.outputs.tag }}
        run: |
          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release $TAG already exists."
            exit 0
          fi
          gh release create "$TAG" --title "$TAG" --notes-file .release-notes.md

