name: Publish Release

on:
  push:
    branches:
      - main
    paths:
      - "CHANGELOG.md"
      - "scripts/release-prepare/**"
      - "scripts/release-finalize/**"
      - "package.json"
      - ".github/workflows/publish-release.yml"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Resolve version and tag state
        id: release
        run: |
          echo "## Publish status" >> "$GITHUB_STEP_SUMMARY"
          CURRENT_VERSION=$(bun -e 'const p = JSON.parse(await Bun.file("package.json").text()); console.log(p.version)')
          echo "version=${CURRENT_VERSION}" >> "$GITHUB_OUTPUT"
          echo "__ðŸ“¦ Version: ${CURRENT_VERSION}__" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          TAG="v${CURRENT_VERSION}"
          TAG_EXISTS=false

          if git ls-remote --exit-code --tags origin "refs/tags/${TAG}" >/dev/null 2>&1; then
            echo "- â˜‘ï¸ Skipped due to existing tag: ${TAG}" >> "$GITHUB_STEP_SUMMARY"
            TAG_EXISTS=true
          else
            echo "- âœ… No existing tag found for ${TAG}, proceeding with release." >> "$GITHUB_STEP_SUMMARY"
          fi

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "tag_exists=$TAG_EXISTS" >> "$GITHUB_OUTPUT"
      - name: Finalize release artifacts
        id: finalize
        if: steps.release.outputs.tag_exists != 'true'
        run: |
          bun run release:finalize
          echo "- âœ… Finalize release artifacts" >> "$GITHUB_STEP_SUMMARY"

      - name: Create and push release tag
        id: create_tag
        if: steps.release.outputs.tag_exists != 'true'
        env:
          TAG: ${{ steps.release.outputs.tag }}
        run: |
          git tag "$TAG"
          git push origin "$TAG"
          echo "- âœ… create ðŸ·ï¸ ${TAG}" >> "$GITHUB_STEP_SUMMARY"

      - name: Create GitHub Release
        id: create_release
        if: steps.release.outputs.tag_exists != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          TAG: ${{ steps.release.outputs.tag }}
        run: |
          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release $TAG already exists."
            echo "- â˜‘ï¸ release allready exists for ðŸ·ï¸ ${TAG}" >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi
          gh release create "$TAG" --title "$TAG" --notes-file .release-notes.md
          echo "- âœ… release created for ðŸ·ï¸ ${TAG}" >> "$GITHUB_STEP_SUMMARY"

